
 Import packages
import streamlit as st
from snowflake.snowpark.functions import col

# Title and description
st.title(":cup_with_straw: Customize Your Smoothie! :cup_with_straw:")
st.write("Choose the fruits you want in your custom Smoothie!")

# Input for name
name_on_order = st.text_input('Name on Smoothie:')
st.write('The name on your Smoothie will be:', name_on_order)

# Snowflake connection
cnx = st.connection("snowflake")
session = cnx.session()

# Fetch fruit options
fruit_df = session.table("SMOOTHIES.PUBLIC.FRUIT_OPTIONS").select(col('FRUIT_NAME'))
fruit_list = [row['FRUIT_NAME'] for row in fruit_df.collect()]  # Convert to list

# Multiselect for ingredients
ingredients_list = st.multiselect(
    'Choose up to 5 ingredients:',
    fruit_list,
    max_selections=5
)

# Submit order
if st.button('Submit Order'):
    if not name_on_order:
        st.error("Please enter a name for your smoothie.")
    elif not ingredients_list:
        st.error("Please select at least one ingredient.")
    else:
        ingredients_string = ', '.join(ingredients_list)

        try:
            # Use parameterized query to prevent SQL injection
            session.sql("""
                INSERT INTO SMOOTHIES.PUBLIC.ORDERS (INGREDIENTS, NAME_ON_ORDER)
                VALUES (?, ?)
            """).bind([ingredients_string, name_on_order]).collect()

            st.success(f"Your Smoothie is ordered: {name_on_order}! âœ…")
        except Exception as e:
            st.error(f"Error inserting order: {e}")
